<?php
/**
  * Auxiliary functions that will be required by all the classes will be
  * implemented here. We will also update the base structure to a Class soon
  */
include('includes/config.php');
/* Auxiliary SQL helper functions */
function fetchAssoc($query) {
  $result = mysql_query($query);
  $row = mysql_fetch_assoc($result);
  return $row;
}
/* query the User Names into an array from Ids */
function namesFromIds($ps) {
  $names = '';
  foreach($ps as $f) {
    $p = trim($f);
    if ($f == '')
      continue;
    $row = fetchAssoc("SELECT * FROM `users` WHERE `fbid`='$p'");
    if ($names == '')
      $names = $row['name'];
    else
      $names = $names . ',' . $row['name'];
  }
  return $names;
}
/* addUsers will take in the fbids and names of new users and add them to the db */
function addUsers($pids, $pnames) {
  $pidArray = explode(',', $pids);
  $pnameArray = explode(',', $pnames);
  for ($i = 0; $i < sizeof($pidArray); $i++) {
    $pid = $pidArray[$i];
    $pname = $pnameArray[$i];
    $result = mysql_query("SELECT * FROM `users` WHERE `fbid`='$pid'");
    if (!mysql_num_rows($result)) {
      mysql_query("INSERT INTO `users` (`fbid`, `name`) VALUES ".
                  "('$pid', '$pname')");
    }
  }
}


/*Posting on the facebook wall of all the poarticipants*/

function postUsers($pids, $pnames,$debatetopic,$debatedesc,$link){
    $pidArray = explode(',', $pids);
    $pnameArray = explode(',', $pnames);
    $facebook = new Facebook(array(
    'appId'   => '253395578066052',
    'secret'  => '23d20951b5546544b2f2e31183e4b5c0',
    'cookie'  => true
    ));
    $queries = array();
    for ($i=0;$i < sizeof($pidArray);$i++){
        $pid = $pidArray[$i];
        $pname = $pnameArray[$i];   
        $to ='/'.$pid.'/feed';
  /*      
        $ret_obj = $facebook->api('/me/feed', 'POST',
                                    array(
                                    'message'=>$debatetopic,
                                    'name'=>"IIT Debates",
                                    'link'=>$link,
                                    'description'=>$debatedesc
                                    
                                 ));
    */                             
        $body =array('message'=>$debatetopic,'link'=> $link,'description'=>$debatedesc,'name'=>'IIT Debates');
        $queries[] =array('method'=>"POST",'relative_url'=>$to,'body'=> http_build_query($body));
        
    }
    
    try{
        $ret_obj = $facebook->api('/?batch='.urlencode(json_encode($queries)), 'POST');          
    }catch (Exception $o){
//        echo $o;
          $o =-1;    
          echo $o;
    }

}


/* Using IITD uid assigned, we compute all the followers of this uid. */
function getUserFollowers($userid) {
  $query = "SELECT `fbid`, `name` FROM `follower`, `users` ".
           "WHERE `follower`.`uid`='$userid' AND `users`.`fbid`=`follower`.`follower`";
  $result = mysql_query($query);
  $followerIds = '';
  $followerNames = '';
  while ($row = mysql_fetch_assoc($result)) {
    $followerIds = $followerIds . ',' . $row['fbid'];
    $followerNames = $followerNames . ',' . $row['name'];
  }
  return array(substr($followerIds, 1), substr($followerNames, 1));
}

/*update all the activities in the mother table of updates. 
type : 0->created debate
       1->challenged on debate
       2->followed User
       3->followed debate*/
function updateActivity($source,$type,$target,$sourcename,$targetname){
    $query = "INSERT INTO `updates` (`source`, `type`,`target`,`sourcename`, `targetname`) VALUES ".
                "('$source', '$type','$target', '$sourcename', '$targetname')"; 
    $result = mysql_query($query);
    
}
/*Gets all the activities from the mother updates table which are generated by people I follow.*/
function getActivities($friends){
    
    $friendsArray = $friends;
    $query = "SELECT * FROM `updates` ".
               "WHERE `updates`.`source` IN ('$friendsArray')";
    $result = mysql_query($query);
     for ($i = 0; $i < mysql_num_rows($result); $i++){
    $row = mysql_fetch_assoc($result);     
    $type = $row['type'];
    $sourceid= $row['source'];
    $targetid=$row['target'];
    $sourcename= $row['sourcename'];
    $targetname=$row['targetname'];
     echo '<div id="update">';
    if($type==0){
        //created debate
       echo '<a href="../home.php?uid='.$sourceid.'">'.$sourcename.'</a> has created a debate <a href="../debate.php?debid='.$targetid.'">'.$targetname.'</a><br/>';
    }
    else if($type==1){
        echo '<a href="../home.php?uid='.$sourceid.'">'.$sourcename.'</a> has challenged to debate on <a href="../home.php?uid='.$targetid.'">'.$targetname.'</a><br/>';
    }
    else if($type==2){
        echo '<a href="../home.php?uid='.$sourceid.'">'.$sourcename.'</a> is now following <a href="../home.php?uid='.$targetid.'">'.$targetname.'</a><br/>';
    }
    else if($type==3){
        echo '<a href="..//home.php?uid='.$sourceid.'">'.$sourcename.'</a> is now following the debate <a href="../debate.php?debd='.$targetid.'">'.$targetname.'</a><br/>';
    }
     echo '</div>';
  }
}



/* return an array of fbids and their names of the followees of this user */
function getUserFollowees($user) {
  $query = "SELECT `users`.`uid`,`fbid`, `name` FROM `follower`, `users` ".
           "WHERE `follower`='$user' AND `follower`.`uid`=`users`.`uid`";
  $result = mysql_query($query);
  $followeeIds = '';
  $followeeNames = '';
  $fi ='';
  while ($row = mysql_fetch_assoc($result)) {
    $followeeIds = $followeeIds . ',' . $row['fbid'];
    $followeeNames = $followeeNames . ',' . $row['name'];
    $followeeNames = $fi . ',' . $row['uid'];
  }
  return array(substr($followeeIds, 1), substr($followeeNames, 1),substr($followeeNames, 1));
}

/* returns the current vote tally */
function voteCount($upvotes, $downvotes) {
  if ($upvotes == '')
    $upvote = 0;
  else
    $upvote = sizeof(explode(',', $upvotes));
  if ($downvotes == '')
    $downvote = 0;
  else
    $downvote = sizeof(explode(',', $downvotes));
  return $upvote - $downvote;
}
function voteTally($upvotes, $downvotes) {
  $vote_tally = voteCount($upvotes, $downvotes);
  echo '<span class="votes">'.($vote_tally).' votes</span>';
}
function commentInfo($comment, $authorUid, $authorName) {

    $query = "SELECT `uid` FROM `users` ".
               "WHERE `fbid`='$authorUid'";
    $result = mysql_query($query);
    $uid=0;
    while ($row = mysql_fetch_assoc($result)) {
      $uid = $row['uid'];
    }
//    $uid =7;
  echo '
    <div id="comment" name="'.$comment['comid'].'">
    <span class="author"><a href="http://ramante.in/iitdebates/home.php?uid='.$uid.'"><img class="author-pic" src="https://graph.facebook.com/'
            .$comment['author'].'/picture?type=small"/>'.$authorName.'</a></span>
    <br/>
    <span class="comment-data">'.$comment['value'].'</span>
    <br/>';
}
function deleteSupportVote($comment, $user) {
  $dontShow = false;
  if ($comment['author'] == $user) {
    $dontShow = true;
    echo '
    <span class="delete-point votes" title="Delete this point">Delete</span>';
  }
  if (!$dontShow) {
    echo '
    <span class="support-point votes" title="Support this point">Support</span>
    <span class="rebutt-point votes" title="Rebutt this point">Rebutt</span>';
  }
  foreach(explode(',', $comment['upvotes']) as $upvoter) {
    if ($user == $upvoter)
      $dontShow = true;
  }
  foreach(explode(',', $comment['downvotes']) as $downvoter) {
    if ($user == $downvoter)
      $dontShow = true;
  }
  if (!$dontShow) {
    echo '
      <span class="upvote icon-arrow-up" title="Vote Up"></span>
      <span class="downvote icon-arrow-down" title="Vote Down"></span>';
  }
}
function commentsArray($debid) {
  $query = "SELECT * FROM `comments`, `users` WHERE debid='$debid' AND `author`=`fbid`";
  $result = mysql_query($query);
  $comments = array();
  for ($i = 0; $i < mysql_num_rows($result); $i++)
    array_push($comments, mysql_fetch_assoc($result));
  $votes = array();
  foreach ($comments as $key => $row) {
    $votes[$key] = voteCount($row['upvotes'], $row['downvotes']);
  }
  array_multisort($votes, SORT_DESC, $comments);
  return $comments;
}
////////////////////////////////////////////////////////////////////////////////////
/*Updates the debate-TOKEN of the user to the latest TOKEN of the debate. */
function updatetoken($user,$debate,$token){
    $query = "SELECT `debates` FROM `users` ".
             "WHERE `fbid`='$user'";
    $result = mysql_query($query);
    $row = mysql_fetch_assoc($result);     
    $Dtokens = explode(',', $row['debates']);
    $temp='no' ;
    for ($i = 0; $i <sizeof($Dtokens); $i++){

        $t = explode(':', $Dtokens[$i]);
        if($t[0]==$debate){
            if($t[1]!=$token){
                $Dtokens[$i]=$debate.':'.$token;
                $debates = implode(",",$Dtokens);
                mysql_query("UPDATE `users` SET `debates`='$debates'".
                            " WHERE `fbid`='$user'");

            }
        }
    }

}

/*Return the array of (debate,change) for the $user */
function debateUpdates($user){
    $query = "SELECT `debates` FROM `users` ".
             "WHERE `fbid`='$user'";
    $result = mysql_query($query);
    $raw = mysql_fetch_assoc($result);     
    $Dtokens = explode(',', $raw['debates']);
    $didArray = '';
    $debateArray ;
    for ($i = 0; $i <sizeof($Dtokens); $i++){
        $temp = explode(':', $Dtokens[$i]);
        $didArray = $didArray. ',' . $temp[0];
        $debateArray[$temp[0]]= intval($temp[1]);
    }
    $didArray =substr($didArray,1);
    $query = "SELECT `debid`,`token` FROM `debates` ".
               "WHERE `debid` IN ('$didArray')";
    $result = mysql_query($query);
    $row = mysql_fetch_assoc($result);

     for ($i = 0; $i < mysql_num_rows($result); $i++){
         $debateArray[$row['debid']] = intval($row['token']) - $debateArray[$row['debid']];
     }
    
    return $debateArray;
}


?>
